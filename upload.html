<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Minitubee.com — Subir</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="header">
    <div class="logo">Minitubee.com</div>
    <div style="flex:1"></div>
    <button onclick="location.href='index.html'" class="btn" style="background:#222">Inicio</button>
  </header>

  <main style="max-width:900px;margin:28px auto;padding:0 16px">
    <div class="upload-card">
      <h3>Subir nuevo video</h3>
      <input id="title" type="text" placeholder="Título del video" style="width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #eee">
      <textarea id="description" rows="4" placeholder="Descripción (opcional)" style="width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #eee"></textarea>

      <div style="margin-top:8px">
        <input id="fileInput" type="file" accept="video/*">
      </div>

      <div id="previewArea" style="display:none;margin-top:12px">
        <video id="previewVideo" controls style="width:100%;border-radius:8px;background:#000"></video>
        <div style="display:flex;gap:12px;margin-top:8px;align-items:center">
          <img id="thumb" src="" style="width:160px;height:90px;object-fit:cover;border-radius:8px;border:1px solid #eee">
          <div>
            <button id="regen" class="btn" style="background:#222">Regenerar miniatura</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="progress"><i id="progBar"></i></div>
        <div id="status" style="margin-top:8px;color:#606060"></div>
        <div style="text-align:right;margin-top:10px"><button id="uploadBtn" class="btn">Subir a Minitubee</button></div>
      </div>
    </div>
  </main>

<script type="module">
  import { auth, db, storage } from './firebase.js';
  import { ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
  import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const fileInput = document.getElementById('fileInput');
  const previewArea = document.getElementById('previewArea');
  const previewVideo = document.getElementById('previewVideo');
  const thumbImg = document.getElementById('thumb');
  const regen = document.getElementById('regen');
  const progBar = document.getElementById('progBar');
  const status = document.getElementById('status');
  const uploadBtn = document.getElementById('uploadBtn');

  let currentFile = null;
  let currentThumbBlob = null;
  let currentUser = null;

  onAuthStateChanged(auth, u=> currentUser = u);

  fileInput.addEventListener('change', e=>{
    const f = e.target.files[0];
    if(!f) return;
    if(!f.type.startsWith('video')) return alert('Selecciona un archivo de video');
    currentFile = f;
    const url = URL.createObjectURL(f);
    previewVideo.src = url;
    previewVideo.load();
    previewArea.style.display = 'block';
    generateThumb(url).then(blob=>{
      currentThumbBlob = blob;
      thumbImg.src = URL.createObjectURL(blob);
    }).catch(()=>{ thumbImg.src = ''; });
  });

  regen.addEventListener('click', ()=>{
    if(!currentFile) return alert('Primero selecciona un video');
    generateThumb(URL.createObjectURL(currentFile)).then(b=> { currentThumbBlob = b; thumbImg.src = URL.createObjectURL(b); });
  });

  function generateThumb(videoUrl, seekPercent=0.35){
    return new Promise((res,rej)=>{
      const v = document.createElement('video');
      v.preload = 'metadata';
      v.src = videoUrl;
      v.muted = true;
      v.playsInline = true;
      v.addEventListener('loadedmetadata', ()=> {
        const t = Math.min(v.duration * seekPercent, Math.max(0, v.duration - 0.1));
        v.currentTime = t;
      });
      v.addEventListener('seeked', ()=> {
        const canvas = document.createElement('canvas');
        const w = v.videoWidth || 1280;
        const h = v.videoHeight || 720;
        canvas.width = Math.min(1280, w);
        canvas.height = Math.round(canvas.width * 9 / 16);
        const ctx = canvas.getContext('2d');
        const sx = Math.max(0, (w - canvas.width) / 2);
        ctx.drawImage(v, sx, 0, canvas.width, canvas.height, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(blob => blob ? res(blob) : rej(new Error('no blob')), 'image/jpeg', 0.85);
      });
      v.addEventListener('error', e=> rej(e));
    });
  }

  uploadBtn.addEventListener('click', async ()=>{
    if(!currentFile) return alert('Selecciona un video');
    if(!currentUser) return alert('Debes iniciar sesión para subir');

    const title = document.getElementById('title').value || currentFile.name;
    status.textContent = 'Iniciando subida...';
    // upload video
    const path = `videos/${Date.now()}_${currentFile.name.replace(/\s+/g,'_')}`;
    const vRef = sRef(storage, path);
    const uploadTask = uploadBytesResumable(vRef, currentFile);

    uploadTask.on('state_changed', snap=>{
      const pct = Math.round((snap.bytesTransferred/snap.totalBytes)*100);
      progBar.style.width = pct + '%';
      status.textContent = 'Subiendo: ' + pct + '%';
    });

    uploadTask.then(async snap=>{
      const videoUrl = await getDownloadURL(snap.ref);

      // subir miniatura
      let thumbUrl = '';
      if(currentThumbBlob){
        const tRef = sRef(storage, path + '_thumb.jpg');
        const tTask = uploadBytesResumable(tRef, currentThumbBlob);
        await tTask;
        thumbUrl = await getDownloadURL(tRef);
      }

      // guardar metadatos
      await addDoc(collection(db,'videos'), {
        title,
        description: document.getElementById('description').value || '',
        videoUrl,
        thumbUrl,
        size: currentFile.size,
        uploaderUid: currentUser.uid,
        uploaderEmail: currentUser.email || 'Anónimo',
        createdAt: serverTimestamp()
      });

      status.textContent = 'Subida completa ✅';
      // reset
      previewArea.style.display = 'none';
      previewVideo.src = '';
      thumbImg.src = '';
      progBar.style.width = '0%';
    }).catch(e=>{
      console.error(e);
      alert('Error al subir: ' + (e.message||e));
    });
  });
</script>
</body>
</html>