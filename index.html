<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MiniTube — Subir Videos</title>
<style>
  :root{
    --bg:#0f1720;
    --card:#0b1220;
    --accent:#ff0000;
    --muted:#9aa4b2;
    --glass: rgba(255,255,255,0.03);
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    background: linear-gradient(180deg,#071021 0%, #0b1220 100%);
    color:#e6eef6;
    padding:24px;
  }
  .container{
    max-width:1100px;
    margin:0 auto;
    display:grid;
    grid-template-columns: 420px 1fr;
    gap:20px;
    align-items:start;
  }

  /* SIDEBAR (Upload panel) */
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:var(--radius);
    padding:18px;
    box-shadow: 0 6px 30px rgba(2,6,23,0.6);
  }
  h1{font-size:18px;margin:0 0 12px 0}
  .drop{
    border:2px dashed rgba(255,255,255,0.06);
    padding:24px;
    border-radius:12px;
    text-align:center;
    cursor:pointer;
    transition:background .12s, border-color .12s, transform .08s;
    background:var(--glass);
    color:var(--muted);
  }
  .drop.dragover{
    border-color: rgba(255,255,255,0.18);
    transform:translateY(-2px);
    background: rgba(255,255,255,0.02);
  }
  input[type="file"]{display:none}
  label.btn{
    display:inline-block;
    margin-top:12px;
    padding:10px 14px;
    border-radius:999px;
    background:rgba(255,255,255,0.03);
    color:#e9f2ff;
    font-weight:600;
    cursor:pointer;
    border:1px solid rgba(255,255,255,0.04);
  }

  .meta{margin-top:14px; display:grid; gap:10px}
  .meta input[type="text"], .meta textarea{
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.03);
    background: rgba(0,0,0,0.25);
    color: #e6eef6;
    resize:vertical;
  }
  .meta-row{display:flex; gap:8px}
  .small{font-size:12px;color:var(--muted)}

  .preview{
    margin-top:14px;
    display:grid;
    gap:8px;
  }
  video{
    width:100%;
    border-radius:10px;
    background:black;
    max-height:240px;
  }
  .thumb{
    width:180px;
    height:100px;
    object-fit:cover;
    border-radius:6px;
    border:1px solid rgba(255,255,255,0.03);
  }

  .progress{
    height:10px;
    width:100%;
    background: rgba(255,255,255,0.03);
    border-radius:999px;
    overflow:hidden;
  }
  .progress > i{
    display:block;
    height:100%;
    width:0%;
    background: linear-gradient(90deg, var(--accent), #ff7b7b);
    transition: width .2s linear;
  }

  .actions{
    margin-top:12px;
    display:flex;
    gap:8px;
    align-items:center;
  }
  .primary{
    background:linear-gradient(180deg,var(--accent),#c80000);
    border:none;
    color:white;
    padding:10px 14px;
    border-radius:10px;
    cursor:pointer;
    font-weight:700;
  }
  .secondary{
    background:transparent;
    color:var(--muted);
    border:1px solid rgba(255,255,255,0.03);
    padding:8px 12px;
    border-radius:8px;
    cursor:pointer;
  }

  /* RIGHT: gallery / listado "subidos" */
  .list{
    display:grid;
    gap:14px;
  }
  .video-card{
    display:flex;
    gap:12px;
    align-items:flex-start;
    background: rgba(255,255,255,0.015);
    padding:12px;
    border-radius:12px;
  }
  .video-card img{width:160px;height:90px;object-fit:cover;border-radius:8px}
  .video-info h3{margin:0;font-size:15px}
  .video-info p{margin:6px 0 0 0;color:var(--muted);font-size:13px}

  .empty{color:var(--muted);text-align:center;padding:40px;border-radius:12px}
  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
  @media (max-width:980px){
    .container{grid-template-columns:1fr; padding-bottom:40px}
  }
</style>
</head>
<body>
  <div class="container">
    <!-- UPLOAD PANEL -->
    <div class="card" id="uploader">
      <h1>Sube tu video</h1>
      <div id="dropZone" class="drop">
        Arrastra y suelta un video aquí<br>
        <small class="small">MP4, WebM, MOV — máximo 200 MB</small><br>
        <label class="btn" for="fileInput">Seleccionar archivo</label>
        <input id="fileInput" type="file" accept="video/*">
      </div>

      <div class="meta">
        <input id="title" type="text" placeholder="Título del video (obligatorio)" />
        <textarea id="description" rows="3" placeholder="Descripción (opcional)"></textarea>
        <div class="meta-row">
          <input id="tags" type="text" placeholder="Etiquetas separadas por comas" />
          <input id="privacy" type="text" placeholder="Privacidad (pública/privada)" style="width:140px" />
        </div>

        <div class="preview" id="previewArea" style="display:none">
          <div>
            <video id="videoPreview" controls></video>
          </div>
          <div style="display:flex; gap:12px; align-items:center">
            <img id="thumbPreview" class="thumb" alt="miniatura">
            <div>
              <div class="small">Miniatura generada automáticamente</div>
              <button id="regenThumb" class="secondary" style="margin-top:8px">Regenerar miniatura</button>
            </div>
          </div>

          <div class="small">Progreso de subida</div>
          <div class="progress"><i id="progBar"></i></div>
        </div>

        <div class="actions">
          <button id="uploadBtn" class="primary">Subir video</button>
          <button id="clearBtn" class="secondary">Limpiar</button>
          <div style="flex:1"></div>
          <div class="small" id="statusText"></div>
        </div>
      </div>
    </div>

    <!-- GALLERY -->
    <div>
      <div class="card">
        <h1>Tus videos</h1>
        <div id="list" class="list">
          <div class="empty">Aún no has subido videos.</div>
        </div>
        <footer>MiniTube demo — no es un servicio real. Implementa tu backend para guardar videos.</footer>
      </div>
    </div>
  </div>

<script>
/*
  MiniTube frontend:
  - permite arrastrar/soltar o seleccionar un video
  - muestra vista previa y genera miniatura (captura de frame)
  - envía al endpoint /upload con XHR para mostrar progreso
  - mantiene lista "local" de videos en localStorage (simulación)
*/

const fileInput = document.getElementById('fileInput');
const dropZone = document.getElementById('dropZone');
const previewArea = document.getElementById('previewArea');
const videoPreview = document.getElementById('videoPreview');
const thumbPreview = document.getElementById('thumbPreview');
const uploadBtn = document.getElementById('uploadBtn');
const clearBtn = document.getElementById('clearBtn');
const regenThumb = document.getElementById('regenThumb');
const progBar = document.getElementById('progBar');
const statusText = document.getElementById('statusText');
const titleInput = document.getElementById('title');
const descInput = document.getElementById('description');
const tagsInput = document.getElementById('tags');
const privacyInput = document.getElementById('privacy');
const listEl = document.getElementById('list');

let currentFile = null;
let currentThumbBlob = null;

const MAX_SIZE_BYTES = 200 * 1024 * 1024; // 200 MB

// Helpers
function showStatus(text){ statusText.textContent = text || '' }
function bytesToMB(n){ return (n/1024/1024).toFixed(2) + ' MB' }

function validFile(file){
  if(!file) return false;
  if(!file.type.startsWith('video')) return false;
  if(file.size > MAX_SIZE_BYTES){
    alert('Archivo demasiado grande: ' + bytesToMB(file.size) + '. Máx 200 MB.');
    return false;
  }
  return true;
}

function resetUploader(){
  currentFile = null;
  currentThumbBlob = null;
  videoPreview.src = '';
  thumbPreview.src = '';
  previewArea.style.display = 'none';
  fileInput.value = '';
  titleInput.value = '';
  descInput.value = '';
  tagsInput.value = '';
  privacyInput.value = '';
  progBar.style.width = '0%';
  showStatus('');
}

function loadListFromStorage(){
  const raw = localStorage.getItem('minitube_videos');
  try{
    const arr = raw ? JSON.parse(raw) : [];
    renderList(arr);
  }catch(e){
    localStorage.removeItem('minitube_videos');
    renderList([]);
  }
}

function saveToLocalList(item){
  const raw = localStorage.getItem('minitube_videos');
  const arr = raw ? JSON.parse(raw) : [];
  arr.unshift(item); // nuevo al inicio
  localStorage.setItem('minitube_videos', JSON.stringify(arr.slice(0,30))); // guardar max 30
  renderList(arr);
}

function renderList(arr){
  listEl.innerHTML = '';
  if(!arr || arr.length === 0){
    listEl.innerHTML = '<div class="empty">Aún no has subido videos.</div>';
    return;
  }
  arr.forEach(v=>{
    const div = document.createElement('div');
    div.className = 'video-card';
    div.innerHTML = `
      <img src="${v.thumb}" alt="thumb">
      <div class="video-info">
        <h3>${escapeHtml(v.title || 'Sin título')}</h3>
        <p>${escapeHtml(v.description || '')}</p>
        <div class="small">${v.size} • ${v.date}</div>
      </div>
    `;
    listEl.appendChild(div);
  });
}

// Escapar texto para seguridad cuando mostramos en innerHTML
function escapeHtml(s){
  if(!s) return '';
  return s.replace(/[&<>"']/g, (m) => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"
  }[m]));
}

// Drag & drop
['dragenter','dragover'].forEach(ev=>{
  dropZone.addEventListener(ev, e=>{
    e.preventDefault();
    e.stopPropagation();
    dropZone.classList.add('dragover');
  });
});
['dragleave','drop'].forEach(ev=>{
  dropZone.addEventListener(ev, e=>{
    e.preventDefault();
    e.stopPropagation();
    dropZone.classList.remove('dragover');
  });
});
dropZone.addEventListener('drop', e=>{
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  handleFileSelection(f);
});
dropZone.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', ()=> handleFileSelection(fileInput.files[0]));

// Manejo archivo
function handleFileSelection(file){
  if(!validFile(file)) return;
  currentFile = file;
  // Vista previa
  const url = URL.createObjectURL(file);
  videoPreview.src = url;
  videoPreview.load();
  previewArea.style.display = 'block';
  showStatus('Archivo listo: ' + file.name + ' (' + bytesToMB(file.size) + ')');
  // Generar miniatura
  generateThumbnail(url, 1.0).then(blobUrl=>{
    thumbPreview.src = blobUrl;
    // convert blobUrl to base64 for storage later (optional)
    fetch(blobUrl).then(r=>r.blob()).then(b=>{
      currentThumbBlob = b;
    });
  }).catch(err=>{
    console.warn('No se pudo generar miniatura', err);
    thumbPreview.src = '';
  });
}

// Generar miniatura desde un frame del video
function generateThumbnail(videoUrl, seekTo = 1.0){
  return new Promise((resolve, reject) => {
    const video = document.createElement('video');
    video.preload = 'metadata';
    video.src = videoUrl;
    video.muted = true;
    video.playsInline = true;
    video.addEventListener('loadedmetadata', ()=>{
      // si video es muy corto, ajustar seek
      const time = Math.min(seekTo, Math.max(0, video.duration * 0.3));
      video.currentTime = time;
    });
    video.addEventListener('seeked', ()=>{
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 360;
      // escalar a proporción 16:9 para la miniatura
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob=>{
        if(!blob) return reject(new Error('No se pudo crear blob de miniatura'));
        const blobUrl = URL.createObjectURL(blob);
        resolve(blobUrl);
      }, 'image/jpeg', 0.85);
    });
    video.addEventListener('error', (e)=> reject(e));
  });
}

// Subir al servidor (ejemplo con XHR para progreso)
uploadBtn.addEventListener('click', ()=>{
  if(!currentFile){ alert('Selecciona un video primero.'); return; }
  if(!titleInput.value.trim()){ if(!confirm('Sin título. ¿Continuar?')) return; }
  // Prepara formData
  const fd = new FormData();
  fd.append('video', currentFile, currentFile.name);
  fd.append('title', titleInput.value || '');
  fd.append('description', descInput.value || '');
  fd.append('tags', tagsInput.value || '');
  fd.append('privacy', privacyInput.value || 'public');

  // endpoint a tu servidor que reciba multipart/form-data
  const UPLOAD_URL = '/upload'; // cambia a la ruta real de tu backend

  const xhr = new XMLHttpRequest();
  xhr.open('POST', UPLOAD_URL, true);

  xhr.upload.onprogress = function(e){
    if(e.lengthComputable){
      const pct = Math.round((e.loaded / e.total) * 100);
      progBar.style.width = pct + '%';
      showStatus('Subiendo — ' + pct + '%');
    }
  };
  xhr.onload = function(){
    if(xhr.status >= 200 && xhr.status < 300){
      showStatus('Subida completa ✅');
      // Respuesta esperada: JSON con info del video (url, thumbUrl, etc.)
      let res;
      try{ res = JSON.parse(xhr.responseText); }catch(e){ res = null; }
      // Si servidor no devuelve miniatura, guardamos la generada localmente como dataURL
      if(res && res.thumbUrl){
        saveToLocalList({
          title: titleInput.value,
          description: descInput.value,
          thumb: res.thumbUrl,
          size: bytesToMB(currentFile.size),
          date: new Date().toLocaleString()
        });
      } else {
        // convertir currentThumbBlob a base64 para mostrar localmente
        if(currentThumbBlob){
          const reader = new FileReader();
          reader.onload = function(){ saveToLocalList({
            title: titleInput.value,
            description: descInput.value,
            thumb: reader.result,
            size: bytesToMB(currentFile.size),
            date: new Date().toLocaleString()
          }); resetUploader(); };
          reader.readAsDataURL(currentThumbBlob);
        } else {
          saveToLocalList({
            title: titleInput.value,
            description: descInput.value,
            thumb: '',
            size: bytesToMB(currentFile.size),
            date: new Date().toLocaleString()
          });
          resetUploader();
        }
      }
    } else {
      showStatus('Error al subir: ' + xhr.statusText);
      alert('La subida falló. Asegúrate de tener un backend que acepte /upload');
    }
  };
  xhr.onerror = function(){
    showStatus('Error en la conexión');
    alert('Error en la conexión al servidor. Revisa la consola del navegador.');
  };

  // COMIENZA subida
  xhr.send(fd);
  showStatus('Iniciando subida...');
});

// Botones
clearBtn.addEventListener('click', ()=> {
  if(confirm('Limpiar formulario?')) resetUploader();
});
regenThumb.addEventListener('click', ()=>{
  if(!currentFile) return alert('Primero selecciona un video');
  const url = URL.createObjectURL(currentFile);
  generateThumbnail(url, 1.5).then(blobUrl=>{
    thumbPreview.src = blobUrl;
    fetch(blobUrl).then(r=>r.blob()).then(b=> currentThumbBlob = b);
  }).catch(()=>alert('No se pudo regenerar miniatura'));
});

// AL CARGAR página
loadListFromStorage();

</script>
</body>
</html>
