<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Minitubee.com — Inicio</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="header">
    <div class="logo">Minitubee<span style="font-weight:400;color:#222">.com</span></div>

    <div class="searchbar">
      <input id="searchInput" placeholder="Buscar videos, etiquetas, títulos...">
      <button id="searchBtn" class="btn">Buscar</button>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <div id="userEmail" style="color:#333;font-weight:600"></div>
      <button id="uploadNav" class="btn">Subir</button>
      <button id="authBtn" class="btn" style="background:#222">Iniciar</button>
    </div>
  </header>

  <main class="container">
    <aside class="left">
      <div class="card upload-card" style="margin-bottom:12px">
        <h3>Bienvenido</h3>
        <p style="color:#606060">Regístrate para subir, comentar y dar like.</p>
        <div style="margin-top:8px">
          <button id="openLoginSmall" class="btn" style="background:#222">Iniciar / Registrar</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Categorías</h3>
        <ul style="list-style:none;padding:8px 0;margin:0;color:#333">
          <li style="padding:6px 0">Destacados</li>
          <li style="padding:6px 0">Musica</li>
          <li style="padding:6px 0">Gaming</li>
          <li style="padding:6px 0">Tutoriales</li>
        </ul>
      </div>
    </aside>

    <section class="main">
      <div class="toolbar">
        <div style="font-weight:700">Explorar</div>
        <div style="color:#606060">Últimos videos públicos</div>
      </div>

      <div id="grid" class="grid">
        <div style="grid-column:1/-1;padding:40px;text-align:center;color:#606060">Cargando videos…</div>
      </div>
    </section>
  </main>

  <!-- Modal: Player -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="player" role="dialog" aria-modal="true" style="position:relative">
      <button id="closePlayer" class="close-btn">✕</button>
      <video id="modalVideo" controls></video>
      <div class="meta">
        <h3 id="modalTitle"></h3>
        <p id="modalDesc" style="color:#606060"></p>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="likeBtn" class="btn" style="background:#222">Like</button>
          <button id="openWatchPage" class="btn">Abrir página</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Login / Register modal (simple) -->
  <div id="loginModal" class="modal">
    <div class="player login-box" style="width:380px;max-width:94%;border-radius:12px;padding:18px;">
      <button class="close-btn" onclick="closeAuth()">✕</button>
      <h3 style="margin:0 0 8px 0">Iniciar sesión / Crear cuenta</h3>
      <input id="email" type="email" placeholder="Correo" style="width:100%;padding:10px;border-radius:8px;border:1px solid #eee;margin:8px 0">
      <input id="password" type="password" placeholder="Contraseña" style="width:100%;padding:10px;border-radius:8px;border:1px solid #eee;margin:8px 0">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnLogin" class="btn" style="flex:1;background:#222">Entrar</button>
        <button id="btnRegister" class="btn" style="flex:1">Crear</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db, storage } from './firebase.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // DOM
    const grid = document.getElementById('grid');
    const uploadNav = document.getElementById('uploadNav');
    const authBtn = document.getElementById('authBtn');
    const openLoginSmall = document.getElementById('openLoginSmall');
    const loginModal = document.getElementById('loginModal');
    const closeAuthBtn = document.querySelector('#loginModal .close-btn');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const btnLogin = document.getElementById('btnLogin');
    const btnRegister = document.getElementById('btnRegister');
    const userEmail = document.getElementById('userEmail');

    // Auth modal controls
    function openAuth(){ loginModal.style.display = 'flex'; loginModal.classList.add('open'); }
    window.openAuth = openAuth;
    function closeAuth(){ loginModal.style.display = 'none'; loginModal.classList.remove('open'); }
    window.closeAuth = closeAuth;

    uploadNav.addEventListener('click', ()=> location.href = 'upload.html');
    authBtn.addEventListener('click', openAuth);
    openLoginSmall.addEventListener('click', openAuth);

    // Auth actions
    import { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    btnRegister.addEventListener('click', async ()=>{
      try{
        await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
        alert('Cuenta creada');
        closeAuth();
      }catch(e){ alert(e.message); }
    });
    btnLogin.addEventListener('click', async ()=>{
      try{
        await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
        alert('Bienvenido');
        closeAuth();
      }catch(e){ alert(e.message); }
    });

    // Show user
    onAuthStateChanged(auth, user=>{
      if(user) { userEmail.textContent = user.email; authBtn.textContent = 'Salir'; authBtn.onclick = ()=> signOut(auth); }
      else { userEmail.textContent = ''; authBtn.textContent = 'Iniciar'; authBtn.onclick = openAuth; }
    });

    // Load videos (realtime)
    import { getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const videosCol = collection(db, 'videos');
    const q = query(videosCol, orderBy('createdAt', 'desc'));

    onSnapshot(q, snapshot=>{
      grid.innerHTML = '';
      if(snapshot.empty){ grid.innerHTML = '<div style="grid-column:1/-1;padding:40px;text-align:center;color:#606060">Sin videos aún</div>'; return; }
      snapshot.forEach(docSnap=>{
        const d = docSnap.data();
        const card = document.createElement('div');
        card.className = 'video-card';
        card.innerHTML = `
          <img class="thumb" src="${d.thumbUrl || ''}" onerror="this.src='https://via.placeholder.com/480x270?text=No+thumb'"/>
          <div class="v-info">
            <div class="v-title">${d.title || 'Sin título'}</div>
            <div class="v-meta">${d.uploaderEmail || 'Anónimo'} • ${new Date(d.createdAt?.seconds ? d.createdAt.seconds *1000 : Date.now()).toLocaleString()}</div>
          </div>
        `;
        card.addEventListener('click', ()=> {
          // abrir watch con id
          location.href = `watch.html?id=${docSnap.id}`;
        });
        grid.appendChild(card);
      });
    });

    // Simple search: client-side (filter DOM)
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    searchBtn.addEventListener('click', ()=>{
      const q = (searchInput.value||'').toLowerCase();
      const cards = Array.from(document.querySelectorAll('.video-card'));
      cards.forEach(c=>{
        c.style.display = (c.textContent||'').toLowerCase().includes(q) ? '' : 'none';
      });
    });

    // Modal player (optional quick preview)
    const modal = document.getElementById('modal');
    const modalVideo = document.getElementById('modalVideo');
    const modalTitle = document.getElementById('modalTitle');
    const modalDesc = document.getElementById('modalDesc');
    const closePlayer = document.getElementById('closePlayer');
    closePlayer.addEventListener('click', ()=> { modal.classList.remove('open'); modalVideo.pause(); modalVideo.src = ''; });
    window.openPlayer = (url,title,desc)=> {
      modal.classList.add('open');
      modalVideo.src = url;
      modalTitle.textContent = title;
      modalDesc.textContent = desc;
    };
  </script>
</body>
</html>