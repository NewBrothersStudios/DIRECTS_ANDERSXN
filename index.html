<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Poppy Playtime CHAPTER 4 ‚Äî Demo Real-Time</title>

<link href="https://fonts.googleapis.com/css2?family=Creepster&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#071018; --panel:#0f1720; --accent:#1eb980; --muted:#98a0aa;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#041018,#071018);}
  .center{max-width:980px;margin:28px auto;padding:18px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03);color:#eaf4fb}
  .header{display:flex;align-items:center;gap:16px}
  .logo{width:120px;height:120px;border-radius:12px;background:linear-gradient(180deg,#0b1116,#071018);display:flex;align-items:center;justify-content:center;font-family:"Creepster",cursive;font-size:34px}
  h1{margin:0;font-size:20px}
  .studio{color:var(--muted);font-size:13px;margin-top:6px}
  .desc{color:var(--muted);margin-top:12px;line-height:1.5}

  /* Sticky download bar */
  .download-bar{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;max-width:980px;width:calc(100% - 36px);background:linear-gradient(180deg,#071018,#041018);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 12px 36px rgba(0,0,0,0.6);display:flex;align-items:center;gap:14px;z-index:90}
  .info{flex:1}
  .title{font-weight:800}
  .estimate{color:var(--muted);font-size:13px;margin-top:6px}
  .progress{height:14px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden;margin-top:10px;border:1px solid rgba(0,0,0,0.25)}
  .bar{height:100%;width:0;background:linear-gradient(90deg, rgba(30,185,128,0.18), rgba(30,185,128,0.6));transition:width 400ms linear}
  .pct{width:72px;text-align:right;font-weight:700;color:#eaf4fb}
  .download-btn{background:linear-gradient(180deg,var(--accent),#16a66b);border:none;padding:12px 16px;border-radius:10px;font-weight:800;color:white;cursor:pointer;display:flex;align-items:center;gap:8px;position:relative;overflow:visible}
  .pulse{animation:btnPulse 1.6s ease-in-out infinite}
  @keyframes btnPulse{0%{transform:scale(1)}50%{transform:scale(1.07)}100%{transform:scale(1)}}

  /* Fullscreen overlays */
  .overlay{position:fixed;inset:0;background:rgba(3,6,10,0.86);display:flex;align-items:center;justify-content:center;z-index:120;flex-direction:column;color:#fff;padding:24px;text-align:center}
  .overlay h2{font-family:"Creepster",cursive;font-size:44px;margin-bottom:12px}
  .overlay .sub{font-size:18px;color:var(--muted)}
  .big-note{position:fixed;left:16px;top:16px;background:#15181a;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);color:#ffd9d9;z-index:130;font-weight:700}

  /* small toast */
  .toast{position:fixed;right:18px;bottom:120px;background:rgba(20,20,20,0.95);padding:10px 14px;color:#dff8ea;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.6);z-index:200}

  @media (max-width:720px){
    .logo{width:88px;height:88px}
    .overlay h2{font-size:32px}
    .download-bar{padding:12px}
    .pct{display:none}
  }
</style>
</head>
<body>

<div class="center">
  <div class="card">
    <div class="header">
      <div class="logo">PP4</div>
      <div>
        <h1>POPPY PLAYTIME CHAPTER 4</h1>
        <div class="studio">ANDZXX &amp; NEW BROTHERS STUDIOS</div>
        <div class="estimate">Adventure ‚Ä¢ Horror ‚Ä¢ Single Player</div>
      </div>
    </div>

    <p class="desc">
      This demo reproduces a real-time download + install sequence exactly as specified. 
      <strong>No se salgan de la p√°gina</strong> ‚Äî if you leave the tab or navigate away, the download will be invalidated.
    </p>
  </div>
</div>

<!-- Sticky download bar -->
<div class="download-bar" role="region" aria-label="Download bar">
  <div class="info">
    <div class="title">POPPY PLAYTIME CHAPTER 4</div>
    <div class="estimate" id="estimateText">Ready to download</div>

    <div class="progress" id="progressWrap" style="display:block">
      <div class="bar" id="progressBar" style="width:0%"></div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
      <div id="statusText" style="color:var(--muted);font-size:13px">Waiting</div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="timeLeft" style="color:var(--muted);font-size:13px">‚Äî</div>
        <div class="pct" id="pct">0%</div>
      </div>
    </div>
  </div>

  <div>
    <div class="pulse">
      <button id="downloadBtn" class="download-btn" aria-pressed="false" title="Descargar ¬°DESCARGAR!">
        <!-- icon -->
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 11l4 4 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        ¬°DESCARGAR!
      </button>
    </div>
  </div>
</div>

<!-- Big fixed warning (do not leave) -->
<div class="big-note" id="stayNote">üìÉ NO SALIR DE LA P√ÅGINA ‚Äî Si sales, la descarga no ser√° v√°lida</div>

<!-- Overlays (hidden by default) -->
<div id="fullOverlay" class="overlay" style="display:none">
  <h2 id="overlayTitle">¬°DESCARGA COMPLETADA!</h2>
  <div class="sub" id="overlaySub">Success</div>
</div>

<!-- Secondary small overlay used for install/failed messages -->
<div id="smallOverlay" class="overlay" style="display:none;align-items:center;justify-content:center;gap:12px">
  <div style="font-size:20px;font-weight:700" id="smallText">INSTALANDO ARCHIVOS...</div>
  <div id="smallHint" style="color:var(--muted);font-size:14px">Por favor espere ‚Äî esto tarda 5 minutos</div>
</div>

<!-- Toast holder -->
<div id="toastHolder"></div>

<script>
/* ========== Config (real durations in seconds) ========== */
const OUTCOMES = [
  {prob:0.6, label:"Estimated: 4h", seconds: 4 * 3600},
  {prob:0.2, label:"Estimated: 2h 30m", seconds: 2.5 * 3600},
  {prob:0.2, label:"Estimated: 5h", seconds: 5 * 3600},
];
const FULLSCREEN_COMPLETE_MS = 4000; // 4 seconds display of "¬°DESCARGA COMPLETADA!"
const INSTALL_MS = 5 * 60 * 1000; // 5 minutes in ms for "INSTALANDO ARCHIVOS..."
/* ========== End config ========== */

const btn = document.getElementById('downloadBtn');
const progressBar = document.getElementById('progressBar');
const pct = document.getElementById('pct');
const statusText = document.getElementById('statusText');
const estimateText = document.getElementById('estimateText');
const timeLeft = document.getElementById('timeLeft');

const fullOverlay = document.getElementById('fullOverlay');
const overlayTitle = document.getElementById('overlayTitle');
const overlaySub = document.getElementById('overlaySub');
const smallOverlay = document.getElementById('smallOverlay');
const smallText = document.getElementById('smallText');
const smallHint = document.getElementById('smallHint');

let downloadState = null; // null or object with state
let raf = null;

// Choose weighted random
function chooseWeighted(arr){
  const r = Math.random();
  let acc = 0;
  for (const it of arr){
    acc += it.prob;
    if (r <= acc) return it;
  }
  return arr[arr.length-1];
}

// Simple toast
function showToast(text){
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = text;
  document.body.appendChild(t);
  setTimeout(()=> t.style.opacity = '1', 20);
  setTimeout(()=> { t.style.opacity = '0'; setTimeout(()=> t.remove(), 360); }, 3000);
}

// Format seconds to H:MM:SS or M:SS
function formatHMS(sec){
  sec = Math.max(0, Math.floor(sec));
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = sec % 60;
  if (h > 0) return `${h}h ${String(m).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`;
  return `${m}m ${String(s).padStart(2,'0')}s`;
}

// Cancel and invalidate download (called when user leaves tab or reloads)
function invalidateDownload(reason){
  if(!downloadState) return;
  cancelAnimationFrame(raf);
  downloadState = { status: 'invalidated', reason };
  progressBar.style.width = '0%';
  pct.textContent = '0%';
  statusText.textContent = 'Download invalidated';
  estimateText.textContent = 'DESCARGA INVALIDADA';
  timeLeft.textContent = '‚Äî';
  showOverlayTemporary(`DESCARGA INVALIDADA`, `${reason}`, 4000);
}

// Show overlay (full) with message for given ms
function showOverlayTemporary(title, sub, ms){
  overlayTitle.textContent = title;
  overlaySub.textContent = sub;
  fullOverlay.style.display = 'flex';
  setTimeout(()=> fullOverlay.style.display = 'none', ms);
}

// Start download process (real-time)
btn.addEventListener('click', () => {
  if (downloadState && (downloadState.status === 'running' || downloadState.status === 'installing')) {
    // already running
    showToast('Descarga en progreso');
    return;
  }

  // pick outcome (for time display) ‚Äî attempts always end as failed after install
  const pick = chooseWeighted(OUTCOMES);

  // Initialize state
  const now = Date.now();
  downloadState = {
    status: 'running',         // running -> completed -> installing -> failed
    pick,
    startTime: now,
    totalSeconds: pick.seconds, // in seconds
    endTime: now + Math.round(pick.seconds * 1000),
    invalidated: false
  };

  estimateText.textContent = pick.label;
  statusText.textContent = 'Downloading...';
  showToast('Descarga iniciada ‚Äî NO SALIR DE LA P√ÅGINA');

  // start RAF loop which computes based on real time (Date.now())
  function tick(){
    if(!downloadState || downloadState.status !== 'running') return;
    const now = Date.now();
    const elapsedMs = now - downloadState.startTime;
    const totalMs = downloadState.totalSeconds * 1000;
    let progress = Math.min(1, elapsedMs / totalMs);
    const percent = Math.floor(progress * 100);
    progressBar.style.width = percent + '%';
    pct.textContent = percent + '%';

    const remainingSec = Math.ceil((1 - progress) * downloadState.totalSeconds);
    timeLeft.textContent = formatHMS(remainingSec);

    // If progress reached 100%
    if (progress >= 1){
      // finalize download -> show completed overlay for 4s
      downloadState.status = 'completed';
      progressBar.style.width = '100%';
      pct.textContent = '100%';
      statusText.textContent = 'Download complete';
      timeLeft.textContent = '0m 00s';

      // Show full-screen completed for 4s
      fullOverlay.style.display = 'flex';
      overlayTitle.textContent = '¬°DESCARGA COMPLETADA!';
      overlaySub.textContent = 'Please wait...';
      setTimeout(()=> {
        fullOverlay.style.display = 'none';
        // Now go to installing step
        startInstalling();
      }, FULLSCREEN_COMPLETE_MS);
      return;
    }

    raf = requestAnimationFrame(tick);
  }

  raf = requestAnimationFrame(tick);
});

// Installing step (5 minutes), then always fail
function startInstalling(){
  if(!downloadState) return;
  downloadState.status = 'installing';
  statusText.textContent = 'Installing files...';
  smallOverlay.style.display = 'flex';
  smallText.textContent = 'INSTALANDO ARCHIVOS...';
  smallHint.textContent = 'Por favor espere ‚Äî esto tardar√° 5 minutos';

  const installStart = Date.now();
  const installEnd = installStart + INSTALL_MS;

  // Show a realtime countdown during install using RAF
  function installTick(){
    if(!downloadState || downloadState.status !== 'installing') return;
    const now = Date.now();
    const remainingMs = Math.max(0, installEnd - now);
    const remainingSec = Math.ceil(remainingMs / 1000);
    smallHint.textContent = `Tiempo restante: ${formatHMS(remainingSec)}`;

    if (remainingMs <= 0){
      // finishing install -> fail (as requested)
      smallOverlay.style.display = 'none';
      downloadState.status = 'failed';
      statusText.textContent = 'INSTALACI√ìN FALLIDA';
      estimateText.textContent = 'DESCARGA FALLIDA';
      showToast('DESCARGA FALLIDA üòì int√©ntalo de nuevo.');
      // show big full-screen failed message and reset UI to allow retry
      fullOverlay.style.display = 'flex';
      overlayTitle.textContent = 'DESCARGA FALLIDA üòì';
      overlaySub.textContent = 'Int√©ntalo de nuevo';
      setTimeout(()=> {
        fullOverlay.style.display = 'none';
        resetUIAfterFail();
      }, 3000);
      return;
    }
    requestAnimationFrame(installTick);
  }

  requestAnimationFrame(installTick);
}

// Reset UI so user can try again
function resetUIAfterFail(){
  downloadState = null;
  progressBar.style.width = '0%';
  pct.textContent = '0%';
  statusText.textContent = 'Waiting';
  estimateText.textContent = 'Ready to download';
  timeLeft.textContent = '‚Äî';
}

// Invalidate if page hidden or unloading
document.addEventListener('visibilitychange', () => {
  if (document.hidden){
    // user left the tab -> invalidate
    invalidateDownload('Se detect√≥ que dejaste la p√°gina (tab oculta).');
  }
});

// If user tries to close or navigate away - we'll invalidate and show a confirmation dialog
window.addEventListener('beforeunload', (e) => {
  if (downloadState && (downloadState.status === 'running' || downloadState.status === 'installing')){
    // mark invalidated
    invalidateDownload('Intento de salir de la p√°gina durante descarga.');
    // show browser confirm (some browsers ignore custom message)
    e.preventDefault();
    e.returnValue = '';
    return '';
  }
});

// If page is hidden at initial load, we warn as well
if (document.hidden) {
  showToast('La pesta√±a est√° oculta ‚Äî no inicies la descarga si piensas salir.');
}

// Accessibility: keyboard activate
btn.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btn.click(); } });

</script>
</body>
</html>